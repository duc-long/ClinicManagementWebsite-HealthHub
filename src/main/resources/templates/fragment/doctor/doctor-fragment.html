<!--Home -->
<div th:fragment="home">
    <div class="row g-3 mb-2">
        <div class="col-md-4">
            <div class="card-soft">
                <div class="d-flex align-items-center justify-content-between">
                    <i class="fa-solid fa-calendar-day fa-xl"></i>
                </div>
            </div>
        </div>
    </div>
    <hr/>
    <div class="card p-3">
        <div class="section-title">
            <i class="fa-solid fa-calendar-check me-2"></i>
            Patient Appointments
        </div>

        <!-- Search bar -->
        <form class="row g-3 mb-4" th:action="@{/doctor/home}" method="get">
            <div class="col-md-4">
                <input type="text" name="patientName" class="form-control"
                       placeholder="Search by patient name" th:value="${param.patientName}">
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100" type="submit">
                    <i class="fa-solid fa-magnifying-glass me-1"></i>Search
                </button>
            </div>
        </form>

        <!-- Appointment list -->
        <div class="table-responsive">
            <table class="table align-middle">
                <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Patient Name</th>
                    <th>Appointment Date</th>
                    <th>Queue Number</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="appt, iter : ${appointments}">
                    <td th:text="${iter.count}"></td>
                    <td th:text="${appt.patientName}"></td>
                    <td th:text="${#temporals.format(appt.appointmentDate, 'dd/MM/yyyy')}"></td>
                    <td th:text="${appt.queueNumber == null} ? 'None' : ${appt.queueNumber}"></td>
                    <td>
                            <span th:switch="${appt.status.value}">
                                    <span th:case="0" class="badge bg-secondary">Pending</span>
                                    <span th:case="1" class="badge bg-info">Confirmed</span>
                                    <span th:case="2" class="badge bg-danger">Cancelled</span>
                                    <span th:case="3" class="badge bg-success">Paid</span>
                                    <span th:case="4" class="badge bg-dark">No Show</span>
                                    <span th:case="5" class="badge bg-primary">Checked In</span>
                                    <span th:case="6" class="badge bg-warning text-dark">Examined</span>
                            </span>
                    </td>
                    <td th:text="${appt.notes ?: '-'}"></td>
                    <td>
                        <a th:href="@{/doctor/appointments/detail/{id}(id=${appt.appointmentId})}"
                           class="btn btn-outline-primary btn-sm">
                            <i class="fa-solid fa-eye"></i> Start Examination
                        </a>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(appointments)}">
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fa-solid fa-inbox me-2"></i>No appointments found
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Appointment -->
<div th:fragment="search-appointments">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h5 class="m-0 fw-bold">
            <i class="fa-solid fa-calendar-check me-2"></i>Appointments
        </h5>
        <div class="d-flex gap-2">
            <input class="form-control" placeholder="Search patient / reason..." style="max-width:260px"/>
            <button class="btn btn-primary">
                <i class="fa-solid fa-magnifying-glass me-1"></i> Search
            </button>
        </div>
    </div>

    <!-- Content -->
    <div class="table-responsive">
        <!-- ðŸŸ¥ Khi KHÃ”NG cÃ³ dá»¯ liá»‡u -->
        <div th:if="${appointments == null or #lists.isEmpty(appointments)}"
             class="alert alert-info text-center mt-3" role="alert">
            <i class="fa-solid fa-circle-info me-2"></i>
            No appointment data available.
        </div>

        <!-- ðŸŸ© Khi CÃ“ dá»¯ liá»‡u -->
        <table th:if="${appointments != null and !#lists.isEmpty(appointments)}"
               class="table align-middle">
            <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Patient</th>
                <th>Time</th>
                <th>Reason</th>
                <th class="text-end">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="a, i : ${appointments}">
                <td th:text="${i.index + 1}"></td>
                <td th:text="${a.patientName}">Tran Van A</td>
                <td>
                    <span th:text="${#temporals.format(a.appointmentDate, 'dd/MM/yyyy')}"></span>
                </td>
                <td th:text="${a.notes}">Chest pain</td>
                <td class="text-end">
                    <a th:href="@{/doctor/appointments/detail/{id}(id = ${a.appointmentId})}"
                       class="btn btn-sm btn-outline-warning">
                        <i class="fa-solid fa-folder-open me-1"></i> Open
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- appointment-detail -->
<div th:fragment="appointment-detail">
    <style>
        .card-soft {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 24px;
        }

        .info-label {
            font-weight: 600;
            color: #4f8cff;
            width: 160px;
        }

        .info-value {
            font-weight: 500;
            color: #333;
        }

        .btn-hm-primary {
            background-color: #4f8cff;
            border-color: #4f8cff;
            color: #fff;
            transition: 0.2s;
        }

        .btn-hm-primary:hover {
            background-color: #3f78e0;
            border-color: #3f78e0;
        }

        .btn-hm-secondary {
            border-color: #4f8cff;
            color: #4f8cff;
        }

        .btn-hm-secondary:hover {
            background-color: #4f8cff;
            color: #fff;
        }

        .section-title {
            color: #0b1a3a;
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
    </style>

    <div>
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h5 class="section-title mb-0">
                <i class="fa-solid fa-file-medical me-2"></i> Appointment Details
            </h5>
            <span th:text="${#temporals.format(appointment.appointmentDate, 'dd/MM/yyyy')}"
                  class="text-muted small"></span>
        </div>

        <div class="card-soft">
            <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    <div class="d-flex align-items-center">
                        <span class="info-label"><i class="fa-solid fa-user me-2"></i>Patient:</span>
                        <span class="info-value" th:text="${appointment.patientName}">Tran Van A</span>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="d-flex align-items-center">
                        <span class="info-label"><i class="fa-solid fa-user-doctor me-2"></i>Doctor:</span>
                        <span class="info-value" th:text="${appointment.doctorName}">Dr. Nguyen Quoc Kiet</span>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    <div class="d-flex align-items-center">
                        <span class="info-label"><i class="fa-solid fa-calendar-days me-2"></i>Date:</span>
                        <span class="info-value"
                              th:text="${#temporals.format(appointment.appointmentDate, 'dd/MM/yyyy')}">23/10/2025</span>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="d-flex align-items-center">
                        <span class="info-label"><i class="fa-solid fa-clock me-2"></i>Created At:</span>
                        <span class="info-value"
                              th:text="${#temporals.format(appointment.createdAt, 'HH:mm dd/MM/yyyy')}">10:30 22/10/2025</span>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="d-flex align-items-start">
                    <span class="info-label"><i class="fa-solid fa-comment-medical me-2"></i>Reason:</span>
                    <span class="info-value" th:text="${appointment.notes}">Chest pain and dizziness</span>
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <!-- ðŸ”™ Back to Appointments -->
                <a class="btn btn-hm-secondary"
                   th:href="@{/doctor/home}">
                    <i class="fa-solid fa-arrow-left me-1"></i> Back to Home
                </a>

                <!-- âœ… Náº¿u chÆ°a cÃ³ Medical Record -->
                <form th:if="${recordId == null}"
                      th:action="@{/doctor/records/show-create}"
                      method="post"
                      class="d-inline">
                    <input type="hidden" name="appointmentId" th:value="${appointment.appointmentId}">
                    <input type="hidden" name="patientId" th:value="${appointment.patientId}">
                    <button type="submit" class="btn btn-hm-primary">
                        <i class="fa-solid fa-stethoscope me-1"></i> Create Medical Record
                    </button>
                </form>

                <!-- Náº¿u Ä‘Ã£ cÃ³ Medical Record -->
                <a th:if="${recordId != null}"
                   th:href="@{/doctor/records/detail/{recordId}(recordId=${recordId})}"
                   class="btn btn-outline-hm-primary d-inline-block">
                    <i class="fa-solid fa-file-medical me-1"></i> View Medical Record
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Vital Sign -->
<div th:fragment="vital-create">
    <div class="card p-4 shadow-sm">
        <h5 class="text-primary mb-3">
            <i class="fa-solid fa-heart-pulse me-2"></i> Record Vital Signs
        </h5>

        <form th:action="@{/doctor/vitals/save}" method="post" th:object="${vitalDTO}">
            <input type="hidden" th:field="${record.recordId}" th:value="${record.recordId}"/>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Height (cm)</label>
                    <input type="number" step="0.1" th:field="*{heightCm}" class="form-control" required>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Weight (kg)</label>
                    <input type="number" step="0.1" th:field="*{weightKg}" class="form-control" required>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Heart Rate (bpm)</label>
                    <input type="number" th:field="*{heartRate}" class="form-control" required>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Blood Pressure (mmHg)</label>
                    <div class="input-group">
                        <input type="number" th:field="*{systolic}" class="form-control" placeholder="Systolic">
                        <span class="input-group-text">/</span>
                        <input type="number" th:field="*{diastolic}" class="form-control" placeholder="Diastolic">
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Temperature (Â°C)</label>
                    <input type="number" step="0.1" th:field="*{temperature}" class="form-control">
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <a th:href="@{/doctor/home}" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-arrow-left"></i> Back Home
                </a>
                <button type="submit" class="btn btn-success ms-2">
                    <i class="fa-solid fa-floppy-disk"></i> Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Profile -->
<div th:fragment="profile">
    <style>
        .card-soft {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .text-hm-blue {
            color: #4f8cff;
        }

        .btn-outline-secondary:hover {
            background-color: #4f8cff;
            color: #fff;
            border-color: #4f8cff;
        }
    </style>

    <h5 class="fw-bold mb-3">
        <i class="fa-solid fa-user-doctor me-2"></i>Doctor Profile
    </h5>

    <div class="row g-4">
        <!-- Left column: Personal info -->
        <div class="col-lg-8">
            <div class="card-soft p-4">
                <h6 class="fw-semibold mb-3 text-hm-blue">Personal Information</h6>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Full Name</label>
                    <input type="text" class="form-control"
                           th:value="${doctor.fullName} ?: 'â€”'"
                           name="fullName" readonly>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Email</label>
                    <input type="email" class="form-control"
                           th:value="${doctor.email} ?: 'â€”'"
                           name="email" readonly>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Phone</label>
                    <input type="text" class="form-control"
                           th:value="${doctor.phone} ?: 'â€”'"
                           name="phone" readonly>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Department</label>
                    <input type="text" class="form-control"
                           th:value="${department} ?: 'â€”'"
                           name="department" readonly>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Gender</label>
                    <input type="text" class="form-control"
                           th:value="${doctor.gender} ?: 'â€”'"
                           name="gender" readonly>
                </div>

                <div class="col-12 text-end mt-3 d-flex justify-content-end gap-2">
                    <a th:href="@{/doctor/change-password}" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-key me-1"></i> Change Password
                    </a>
                    <a th:href="@{/doctor/profile/edit}" class="btn btn-primary">
                        <i class="fa-solid fa-pen-to-square me-1"></i> Edit Profile
                    </a>
                </div>
            </div>
        </div>

        <!-- Right column: Avatar -->
        <div class="col-lg-4">
            <div class="card-soft text-center p-4">
                <img th:src="${doctor.avatarFileName != null} ? '/images/avatars/doctor' + ${doctor.avatarFileName} : '/images/avatars/default-avatar.png'"
                     class="rounded-circle shadow mb-3 border border-3 border-light"
                     width="140" height="140" alt="Avatar">

                <h6 class="fw-bold mb-1" th:text="${doctor.fullName}">Dr. Nguyen Quoc Kiet</h6>
                <div class="text-muted small mb-3" th:text="${department}">Department</div>

                <form th:action="@{/doctor/avatarFilename}" method="post" enctype="multipart/form-data">
                    <input type="file" name="avatar" class="form-control mb-2" accept="image/*">
                    <button class="btn btn-outline-primary btn-sm w-100">
                        <i class="fa-solid fa-upload me-1"></i> Update Avatar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Create Medical Record -->
<div th:fragment="create-record">
    <style>
        :root {
            --hm-blue: #005691;
            --hm-green: #008744;
        }

        .section-title {
            font-weight: 600;
            color: var(--hm-blue);
        }

        .btn-hm {
            background-color: var(--hm-blue);
            color: white;
        }

        .btn-hm:hover {
            background-color: #003f6f;
            color: white;
        }

        .form-label {
            font-weight: 500;
        }

        textarea {
            resize: vertical;
        }

        .form-section {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }
    </style>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="section-title mb-0">
            <i class="fa-solid fa-file-medical me-2"></i> Create medical records
        </h3>
        <a th:href="@{/doctor/appointments}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left"></i> Back to Appointment
        </a>
    </div>

    <div class="form-section">
        <form th:action="@{/doctor/records/create}" th:object="${record}" method="post"
              enctype="application/x-www-form-urlencoded">
            <!-- CSRF token (náº¿u dÃ¹ng Spring Security) -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf != null}"/>

            <!-- Hidden fields (cÃ³ name Ä‘á»ƒ controller cÃ³ thá»ƒ nháº­n @RequestParam náº¿u cáº§n) -->
            <input type="hidden" name="appointmentId" th:value="${appointmentId}">
            <input type="hidden" name="patientId" th:value="${patientId}">

            <!-- Diagnosis -->
            <div class="mb-3">
                <label for="diagnosis" class="form-label">Diagnose <span class="text-danger">*</span></label>
                <!-- Khi th:object="${record}", dÃ¹ng *{diagnosis} (khÃ´ng pháº£i record.diagnosis) -->
                <textarea id="diagnosis" class="form-control" rows="3"
                          th:field="*{diagnosis}" placeholder="Enter your doctor's diagnosis..."
                          required></textarea>
                <div class="text-danger small" th:if="${#fields.hasErrors('diagnosis')}"
                     th:errors="*{diagnosis}"></div>
            </div>

            <!-- Notes -->
            <div class="mb-3">
                <label for="notes" class="form-label">Note</label>
                <textarea id="notes" class="form-control" rows="4"
                          th:field="*{notes}"
                          placeholder="Additional notes about condition, medication, test results..."></textarea>
                <div class="text-danger small" th:if="${#fields.hasErrors('notes')}" th:errors="*{notes}"></div>
            </div>

            <!-- Status (enum binding) -->
            <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <!-- Náº¿u record.recordStatus lÃ  kiá»ƒu enum RecordStatus, bind trá»±c tiáº¿p *{recordStatus} -->
                <select id="status" class="form-select" th:field="*{recordStatus}">
                    <option th:each="s : ${T(com.group4.clinicmanagement.enums.RecordStatus).values()}"
                            th:value="${s}"
                            th:text="${s.name() == 'OPEN' ? 'Open' : 'Close'}">
                    </option>
                </select>
            </div>

            <!-- Submit -->
            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-hm px-4">
                    <i class="fa-solid fa-floppy-disk me-1"></i> Save the file
                </button>
            </div>

        </form>
    </div>
</div>

<!-- Record Detail -->
<div th:fragment="record-detail">
    <div class="card p-4 shadow-sm">
        <h5 class="text-primary mb-4">
            <i class="fa-solid fa-file-medical me-2"></i> Medical Record Detail
        </h5>

        <!-- âœ… Record Information -->
        <div class="mb-4">
            <h6 class="fw-bold text-secondary mb-2">ðŸ©º Record Information</h6>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Record ID:</strong> <span th:text="${record.recordId}"></span></p>
                    <p><strong>Doctor:</strong> <span th:text="${record.doctorName}"></span></p>
                    <p><strong>Status:</strong>
                        <span th:text="${record.recordStatus}"
                              th:classappend="${record.recordStatus.name() == 'COMPLETED'} ? 'badge bg-success' : 'badge bg-warning text-dark'"></span>
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>Created At:</strong>
                        <span th:text="${#temporals.format(record.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                    <p><strong>Appointment ID:</strong> <span th:text="${record.appointmentId}"></span></p>
                    <p><strong>Patient:</strong> <span th:text="${record.patientName}"></span></p>
                </div>
            </div>
        </div>

        <hr/>

        <!-- âœ… Medical Details -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body">
                <!-- TiÃªu Ä‘á» vÃ  nÃºt Update trÃªn cÃ¹ng -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold text-secondary mb-0">
                        <i class="fa-solid fa-brain me-2 text-primary"></i> Record Details
                    </h6>
                    <div class="d-flex align-items-center">
                        <a th:if="${record.recordId != null and labRequest == null}"
                           th:href="@{/doctor/labs/create/{id}(id=${record.recordId})}"
                           class="btn btn-outline-primary btn-sm">
                            <i class="fa-solid fa-plus me-1"></i> Request Lab Test
                        </a>

                        <a th:if="${record != null
                            and record.recordId != null
                            and labRequest != null}"
                           th:href="@{/doctor/labs/view/{id}(id=${labRequest.labRequestId})}"
                           class="btn btn-outline-primary btn-sm me-xxl-3">
                            <i class="fa-solid fa-eye me-1"></i> View Request Lab Test
                        </a>


                        <!-- update medical record -->
                        <a th:if="${record.recordId != null and record.recordStatus.name() != 'CLOSED'}"
                           th:href="@{/doctor/records/update/{id}(id=${record.recordId})}"
                           class="btn btn-outline-primary btn-sm ms-3">
                            <i class="fa-solid fa-pen-to-square me-1"></i> Update Record
                        </a>
                    </div>
                </div>

                <!-- Ná»™i dung chi tiáº¿t -->
                <div class="ps-1">
                    <p class="mb-1">
                        <strong>Diagnosis:</strong>
                        <span th:text="${record.diagnosis ?: '-'}"></span>
                    </p>
                    <p class="mb-0">
                        <strong>Treatment Plan:</strong>
                        <span th:text="${record.notes ?: '-'}"></span>
                    </p>
                </div>
            </div>
        </div>

        <hr/>

        <!-- âœ… Vital Signs -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold text-secondary">ðŸ’“ Vital Signs</h6>

                <!-- ðŸ‘‰ Náº¿u cÃ³ vitalSigns thÃ¬ chá»‰ hiá»‡n Update, náº¿u chÆ°a cÃ³ thÃ¬ hiá»‡n Create -->
                <a th:if="${vitalSigns == null}"
                   th:href="@{/doctor/vitals/create/{id}(id = ${record.recordId})}"
                   class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-plus"></i> Add Vital Signs
                </a>

                <a th:if="${vitalSigns != null}"
                   th:href="@{/doctor/vitals/update/{id}(id = ${vitalSigns.vitalId})}"
                   class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-pen-to-square me-1"></i> Update Vital Signs
                </a>
            </div>

            <div th:if="${vitalSigns == null}" class="text-muted fst-italic">
                No vital signs recorded yet.
            </div>

            <div th:if="${vitalSigns != null}" class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Height (cm)</th>
                        <th>Weight (kg)</th>
                        <th>Blood Pressure</th>
                        <th>Heart Rate</th>
                        <th>Temperature</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td th:text="${#temporals.format(vitalSigns.recordedAt, 'dd/MM/yyyy HH:mm')}"></td>
                        <td th:text="${vitalSigns.heightCm + ' cm'}"></td>
                        <td th:text="${vitalSigns.weightKg + ' kg'}"></td>
                        <td th:text="${vitalSigns.bloodPressure + ' mmHg'}"></td>
                        <td th:text="${vitalSigns.heartRate + ' bpm'}"></td>
                        <td th:text="${vitalSigns.temperature + ' Â°C'}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr/>

        <!-- âœ… Prescription Detail -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold text-secondary">ðŸ’Š Prescription</h6>

                <!-- ðŸ‘‰ Náº¿u cÃ³ prescription thÃ¬ chá»‰ hiá»‡n Update, náº¿u chÆ°a cÃ³ thÃ¬ hiá»‡n Create -->
                <a th:if="${prescription == null}"
                   th:href="@{/doctor/prescription/create/{id}(id = ${record.recordId})}"
                   class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-plus"></i> Add Prescription
                </a>

                <a th:if="${prescription != null}"
                   th:href="@{/doctor/prescription/update/{id}(id=${prescription.prescriptionId})}"
                   class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-pen-to-square me-1"></i> Update Prescription
                </a>
            </div>

            <div th:if="${prescription == null}" class="text-muted fst-italic">
                No prescription created yet.
            </div>

            <div th:if="${prescription != null}">
                <p><strong>Prescription ID:</strong> <span th:text="${prescription.prescriptionId}"></span></p>

                <div th:if="${prescription.prescriptionDetails}" class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Drug</th>
                            <th>Dosage</th>
                            <th>Quantity</th>
                            <th>Notes</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="d, iter : ${prescription.prescriptionDetails}">
                            <td th:text="${iter.index + 1}"></td>
                            <td th:text="${d.drugName}"></td>
                            <td th:text="${d.dosage}"></td>
                            <td th:text="${d.quantity}"></td>
                            <td th:text="${d.instruction ?: '-'}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <!-- back to medical record detail -->
            <div class="d-flex justify-content-end">
                <a th:href="@{/doctor/appointments/detail/{id}(id=${appointmentId})}" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </a>
            </div>

            <!-- submit form for patient -->
            <div class="d-flex justify-content-end mb-3"
                 th:if="${record.recordId != null and vitalSigns != null and prescription != null}">
                <form th:action="@{/doctor/submit}" method="post">
                    <input type="hidden" name="appointmentId" th:value="${appointmentId}">
                    <button type="submit" class="btn btn-success">
                        <i class="fa-solid fa-circle-check me-1"></i> Submit Record
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Change Password -->
<div th:fragment="change-password">
    <style>
        .cp-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 12px;
            width: 100%;
            box-sizing: border-box;
        }


        .cp-card {
            width: 560px;
            max-width: calc(100% - 32px);
            padding: 28px;
            border-radius: 12px;
            background-color: #fff;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.06);
            color: #222;
        }

        body.dark .cp-card {
            background-color: #1f2937;
            color: #fff;
            border-color: rgba(255, 255, 255, 0.08);
        }

        .cp-title {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }

        .form-control.cp-input {
            width: 100%;
            border-radius: 8px;
            height: 46px;
            padding: 8px 48px 8px 14px;
            border: 1px solid #d6d6d6;
            color: inherit;
            box-sizing: border-box;
        }

        body.dark .form-control.cp-input {
            background-color: transparent;
            border-color: rgba(255, 255, 255, 0.12);
        }

        .input-row { position: relative; margin-bottom: 16px; }

        .input-icon {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%); display:flex; align-items:center;
        }

        .toggle-btn { background: transparent; border: 0; padding: 4px; cursor: pointer; color: #6c757d; }
        .toggle-btn i { font-size: 16px; transition: none; }

        .small-note { font-size: 0.9rem; margin-bottom: 8px; color: #6c757d; }
        body.dark .small-note { color: rgba(255,255,255,0.7); }

        .strength { height: 8px; border-radius: 6px; background-color: rgba(0,0,0,0.06); overflow:hidden; margin-top:6px; margin-bottom:6px; }
        .strength > i { display:block; height:100%; width:0%; transition: width .2s linear; background-color: #6c757d; }
        .strength.weak > i { background-color:#ff6b6b; } .strength.fair > i { background-color:#f59e0b; } .strength.strong > i { background-color:#4ade80; }

        #clientError { min-height:1.2rem; margin-bottom:10px; color:#dc3545; }

        .btn-submit { background-color:#1976d2; color:#fff; border:none; padding:12px 14px; border-radius:8px; width:100%; font-weight:700; }
        .btn-submit:hover { background-color:#145ca9; }
        .btn-submit:disabled { opacity:0.6; cursor:not-allowed; }

        /* Hide native browser reveal/clear on password fields (prevents double-eye) */
        input[type="password"]::-ms-reveal,
        input[type="password"]::-ms-clear { display:none !important; }
        input[type="password"]::-webkit-credentials-auto-fill-button,
        input[type="password"]::-webkit-clear-button,
        input[type="password"]::-webkit-textfield-decoration-container,
        input[type="password"]::-webkit-textfield-decoration { display:none !important; -webkit-appearance:none !important; }
        input[type="password"]::-webkit-textfield-decoration-container > button,
        input[type="password"]::-webkit-textfield-decoration-container > input[type="button"] { display:none !important; }

        @media (max-width: 600px) {
            .cp-card { width: 95%; padding: 18px; }
            .form-control.cp-input { padding: 8px 44px 8px 12px; height:44px; }
        }
    </style>

    <div class="cp-container">
        <div class="cp-card">
            <div class="cp-title">Change Password</div>

            <form th:action="@{/doctor/change-password}" method="post" id="changePasswordForm" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="input-row">
                    <input id="currentPassword" name="currentPassword" type="password" class="form-control cp-input" placeholder="Current password" required />
                    <div class="input-icon">
                        <button class="toggle-btn" type="button" data-target="currentPassword" aria-label="Toggle current password">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="input-row">
                    <input id="newPassword" name="newPassword" type="password" class="form-control cp-input" placeholder="New password" required />
                    <div class="input-icon">
                        <button class="toggle-btn" type="button" data-target="newPassword" aria-label="Toggle new password">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="small-note">Use at least 6 characters â€” include letters, numbers & a special character</div>

                <div class="strength mb-2" aria-hidden="true"><i id="pwdStrengthBar"></i></div>
                <div id="pwdStrengthText" class="small-note mb-2"></div>

                <div class="input-row">
                    <input id="confirmPassword" name="confirmPassword" type="password" class="form-control cp-input" placeholder="Confirm new password" required />
                    <div class="input-icon">
                        <button class="toggle-btn" type="button" data-target="confirmPassword" aria-label="Toggle confirm password">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div id="clientError" class="mb-3"></div>

                <button id="submitBtn" type="submit" class="btn-submit">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        (function () {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function (evt) {
                    evt.preventDefault();
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    if (!input) return;
                    const icon = this.querySelector('i');
                    const isHidden = input.type === 'password';
                    input.type = isHidden ? 'text' : 'password';
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
                btn.style.display = 'inline-flex';
            });

            // keep icon visible on focus/blur (avoid browser quirks)
            ['currentPassword','newPassword','confirmPassword'].forEach(id=>{
                const input = document.getElementById(id);
                const btn = document.querySelector(`button[data-target="${id}"]`);
                if (!input || !btn) return;
                btn.style.visibility = 'visible';
                input.addEventListener('focus', ()=> btn.style.visibility='visible');
                input.addEventListener('blur', ()=> btn.style.visibility='visible');
            });

            // password strength + validation (same logic)
            const newPwd = document.getElementById('newPassword');
            const confirmPwd = document.getElementById('confirmPassword');
            const strengthBar = document.getElementById('pwdStrengthBar');
            const strengthText = document.getElementById('pwdStrengthText');
            const clientError = document.getElementById('clientError');
            const form = document.getElementById('changePasswordForm');
            const submitBtn = document.getElementById('submitBtn');

            const validRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z0-9]).{6,}$/;

            function evaluateStrength(pwd) {
                let score = 0;
                if (!pwd) return score;
                if (pwd.length >= 6) score++;
                if (/[A-Za-z]/.test(pwd)) score++;
                if (/\d/.test(pwd)) score++;
                if (/[^A-Za-z0-9]/.test(pwd)) score++;
                return score;
            }

            function updateStrengthUI() {
                const s = evaluateStrength(newPwd.value);
                const percent = (s / 4) * 100;
                strengthBar.style.width = percent + '%';

                if (!newPwd.value) {
                    strengthText.textContent = '';
                    const note = document.getElementById('pwdValidNote');
                    if (note) note.remove();
                    return;
                }

                if (s <= 1) { strengthText.textContent = 'Weak password'; strengthText.className = 'text-danger small-note'; }
                else if (s === 2) { strengthText.textContent = 'Fair password'; strengthText.className = 'text-warning small-note'; }
                else if (s === 3) { strengthText.textContent = 'Good password'; strengthText.className = 'text-info small-note'; }
                else { strengthText.textContent = 'Strong password'; strengthText.className = 'text-success small-note'; }

                const validNote = document.getElementById('pwdValidNote');
                if (validRegex.test(newPwd.value)) {
                    if (!validNote) {
                        const note = document.createElement('div');
                        note.id = 'pwdValidNote';
                        note.className = 'text-success small-note';
                        note.innerHTML = '<i class="fa-solid fa-check"></i> Password meets all conditions';
                        strengthText.insertAdjacentElement('afterend', note);
                    }
                } else {
                    if (validNote) validNote.remove();
                }
            }

            newPwd.addEventListener('input', ()=>{ updateStrengthUI(); clientError.textContent=''; });
            confirmPwd.addEventListener('input', ()=>{ clientError.textContent=''; });

            form.addEventListener('submit', e=>{
                clientError.textContent='';
                const n = newPwd.value.trim(), c = confirmPwd.value.trim();
                let errors = [];
                if (!validRegex.test(n)) errors.push("Password must be at least 6 characters and include letters, numbers, and a special character.");
                if (n !== c) errors.push("New password and confirm password do not match.");
                if (errors.length) { e.preventDefault(); clientError.innerHTML = errors.map(err=>`<div>${err}</div>`).join(''); newPwd.focus(); return false; }
                submitBtn.disabled = true;
            });

            // init
            updateStrengthUI();
        })();
    </script>
</div>


