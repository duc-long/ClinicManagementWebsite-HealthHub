<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Profile – HealHub</title>

    <!-- Font & Icon -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/receptionist.css}">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">

    <style>
        .cp-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 12px;
            width: 100%;
            box-sizing: border-box;
        }


        .cp-card {
            width: 560px;
            max-width: calc(100% - 32px);
            padding: 28px;
            border-radius: 12px;
            background-color: #fff;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.06);
            color: #222;
        }

        body.dark .cp-card {
            background-color: #1f2937;
            color: #fff;
            border-color: rgba(255, 255, 255, 0.08);
        }

        .cp-title {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }

        .form-control.cp-input {
            width: 100%;
            border-radius: 8px;
            height: 46px;
            padding: 8px 48px 8px 14px;
            border: 1px solid #d6d6d6;
            color: inherit;
            box-sizing: border-box;
        }

        body.dark .form-control.cp-input {
            background-color: transparent;
            border-color: rgba(255, 255, 255, 0.12);
        }

        .input-row { position: relative; margin-bottom: 16px; }

        .input-icon {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%); display:flex; align-items:center;
        }

        .toggle-btn { background: transparent; border: 0; padding: 4px; cursor: pointer; color: #6c757d; }
        .toggle-btn i { font-size: 16px; transition: none; }

        .small-note { font-size: 0.9rem; margin-bottom: 8px; color: #6c757d; }
        body.dark .small-note { color: rgba(255,255,255,0.7); }

        .strength { height: 8px; border-radius: 6px; background-color: rgba(0,0,0,0.06); overflow:hidden; margin-top:6px; margin-bottom:6px; }
        .strength > i { display:block; height:100%; width:0%; transition: width .2s linear; background-color: #6c757d; }
        .strength.weak > i { background-color:#ff6b6b; } .strength.fair > i { background-color:#f59e0b; } .strength.strong > i { background-color:#4ade80; }

        #clientError { min-height:1.2rem; margin-bottom:10px; color:#dc3545; }

        .btn-submit { background-color:#1976d2; color:#fff; border:none; padding:12px 14px; border-radius:8px; width:100%; font-weight:700; }
        .btn-submit:hover { background-color:#145ca9; }
        .btn-submit:disabled { opacity:0.6; cursor:not-allowed; }

        /* Hide native browser reveal/clear on password fields (prevents double-eye) */
        input[type="password"]::-ms-reveal,
        input[type="password"]::-ms-clear { display:none !important; }
        input[type="password"]::-webkit-credentials-auto-fill-button,
        input[type="password"]::-webkit-clear-button,
        input[type="password"]::-webkit-textfield-decoration-container,
        input[type="password"]::-webkit-textfield-decoration { display:none !important; -webkit-appearance:none !important; }
        input[type="password"]::-webkit-textfield-decoration-container > button,
        input[type="password"]::-webkit-textfield-decoration-container > input[type="button"] { display:none !important; }

        @media (max-width: 600px) {
            .cp-card { width: 95%; padding: 18px; }
            .form-control.cp-input { padding: 8px 44px 8px 12px; height:44px; }
        }
    </style>
</head>
<body>
<div th:insert="~{fragment/toast/toast :: toast}"></div>
<div class="app" id="appLayout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand">
            <div class="logo">CSH</div>
            <div class="title hide-when-collapsed">HealHub · Cashier</div>
        </div>

        <button id="toggleSidebar" class="toggle-btn" type="button">
            <i class="fa-solid fa-angles-left"></i>
            <span class="hide-when-collapsed">Collapse</span>
        </button>

        <nav class="nav" id="sideNav">
            <small class="hide-when-collapsed">OVERVIEW</small>
            <a th:href="@{/cashier/appointment-list}">
                <span class="icon"><i class="fa-solid fa-calendar-check"></i></span>
                <span class="hide-when-collapsed">Appointments</span>
            </a>
            <a th:href="@{/cashier/payment-list}">
                <span class="icon"><i class="fa-solid fa-money-check-dollar"></i></span>
                <span class="hide-when-collapsed">Payments</span>
            </a>
            <a th:href="@{/cashier/lab-request-list}">
                <span class="icon"><i class="fa-solid fa-vial"></i></span>
                <span class="hide-when-collapsed">Lab Requests</span>
            </a>
            <small class="hide-when-collapsed mt-2">ACCOUNT</small>
            <a th:href="@{/cashier/profile}" class="active">
                <span class="icon"><i class="fa-solid fa-id-card"></i></span>
                <span class="hide-when-collapsed">Profile</span>
            </a>
            <form th:action="@{/cashier/logout}" method="post" style="margin-top:.5rem;">
                <button class="toggle-btn" type="submit">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span class="hide-when-collapsed">Logout</span>
                </button>
            </form>
        </nav>
    </aside>


    <!-- MAIN -->
    <main class="main">
        <div class="topbar">
            <h4 class="mb-0">Change Password</h4>
        </div>

        <!-- Change Password -->
        <div>
            <div class="cp-container">
                <div class="cp-card">
                    <div class="cp-title">Change Password</div>

                    <form th:action="@{/cashier/change-password}" method="post" id="changePasswordForm" novalidate>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <div class="input-row">
                            <input id="currentPassword" name="currentPassword" type="password"
                                   class="form-control cp-input" placeholder="Current password" required/>
                            <div class="input-icon">
                                <button class="toggle-btn" type="button" data-target="currentPassword"
                                        aria-label="Toggle current password">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="input-row">
                            <input id="newPassword" name="newPassword" type="password" class="form-control cp-input"
                                   placeholder="New password" required/>
                            <div class="input-icon">
                                <button class="toggle-btn" type="button" data-target="newPassword"
                                        aria-label="Toggle new password">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="small-note">Use at least 6 characters — include letters, numbers & a special
                            character
                        </div>

                        <div class="strength mb-2" aria-hidden="true"><i id="pwdStrengthBar"></i></div>
                        <div id="pwdStrengthText" class="small-note mb-2"></div>

                        <div class="input-row">
                            <input id="confirmPassword" name="confirmPassword" type="password"
                                   class="form-control cp-input" placeholder="Confirm new password" required/>
                            <div class="input-icon">
                                <button class="toggle-btn" type="button" data-target="confirmPassword"
                                        aria-label="Toggle confirm password">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div id="clientError" class="mb-3"></div>

                        <button id="submitBtn" type="submit" class="btn-submit">Save Changes</button>
                    </form>
                </div>
            </div>

            <script>
                (function () {
                    document.querySelectorAll('.toggle-btn').forEach(btn => {
                        btn.addEventListener('click', function (evt) {
                            evt.preventDefault();
                            const targetId = this.getAttribute('data-target');
                            const input = document.getElementById(targetId);
                            if (!input) return;
                            const icon = this.querySelector('i');
                            const isHidden = input.type === 'password';
                            input.type = isHidden ? 'text' : 'password';
                            icon.classList.toggle('fa-eye');
                            icon.classList.toggle('fa-eye-slash');
                        });
                        btn.style.display = 'inline-flex';
                    });

                    // keep icon visible on focus/blur (avoid browser quirks)
                    ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => {
                        const input = document.getElementById(id);
                        const btn = document.querySelector(`button[data-target="${id}"]`);
                        if (!input || !btn) return;
                        btn.style.visibility = 'visible';
                        input.addEventListener('focus', () => btn.style.visibility = 'visible');
                        input.addEventListener('blur', () => btn.style.visibility = 'visible');
                    });

                    // password strength + validation (same logic)
                    const newPwd = document.getElementById('newPassword');
                    const confirmPwd = document.getElementById('confirmPassword');
                    const strengthBar = document.getElementById('pwdStrengthBar');
                    const strengthText = document.getElementById('pwdStrengthText');
                    const clientError = document.getElementById('clientError');
                    const form = document.getElementById('changePasswordForm');
                    const submitBtn = document.getElementById('submitBtn');

                    const validRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z0-9]).{6,}$/;

                    function evaluateStrength(pwd) {
                        let score = 0;
                        if (!pwd) return score;
                        if (pwd.length >= 6) score++;
                        if (/[A-Za-z]/.test(pwd)) score++;
                        if (/\d/.test(pwd)) score++;
                        if (/[^A-Za-z0-9]/.test(pwd)) score++;
                        return score;
                    }

                    function updateStrengthUI() {
                        const s = evaluateStrength(newPwd.value);
                        const percent = (s / 4) * 100;
                        strengthBar.style.width = percent + '%';

                        if (!newPwd.value) {
                            strengthText.textContent = '';
                            const note = document.getElementById('pwdValidNote');
                            if (note) note.remove();
                            return;
                        }

                        if (s <= 1) {
                            strengthText.textContent = 'Weak password';
                            strengthText.className = 'text-danger small-note';
                        } else if (s === 2) {
                            strengthText.textContent = 'Fair password';
                            strengthText.className = 'text-warning small-note';
                        } else if (s === 3) {
                            strengthText.textContent = 'Good password';
                            strengthText.className = 'text-info small-note';
                        } else {
                            strengthText.textContent = 'Strong password';
                            strengthText.className = 'text-success small-note';
                        }

                        const validNote = document.getElementById('pwdValidNote');
                        if (validRegex.test(newPwd.value)) {
                            if (!validNote) {
                                const note = document.createElement('div');
                                note.id = 'pwdValidNote';
                                note.className = 'text-success small-note';
                                note.innerHTML = '<i class="fa-solid fa-check"></i> Password meets all conditions';
                                strengthText.insertAdjacentElement('afterend', note);
                            }
                        } else {
                            if (validNote) validNote.remove();
                        }
                    }

                    newPwd.addEventListener('input', () => {
                        updateStrengthUI();
                        clientError.textContent = '';
                    });
                    confirmPwd.addEventListener('input', () => {
                        clientError.textContent = '';
                    });

                    form.addEventListener('submit', e => {
                        clientError.textContent = '';
                        const n = newPwd.value.trim(), c = confirmPwd.value.trim();
                        let errors = [];
                        if (!validRegex.test(n)) errors.push("Password must be at least 6 characters and include letters, numbers, and a special character.");
                        if (n !== c) errors.push("New password and confirm password do not match.");
                        if (errors.length) {
                            e.preventDefault();
                            clientError.innerHTML = errors.map(err => `<div>${err}</div>`).join('');
                            newPwd.focus();
                            return false;
                        }
                        submitBtn.disabled = true;
                    });

                    // init
                    updateStrengthUI();
                })();
            </script>
        </div>
    </main>
</div>

<div class="overlay" id="overlay"></div>

<!-- JS -->
<script>
    const app = document.getElementById('appLayout');
    const toggleBtn = document.getElementById('toggleSidebar');
    const overlay = document.getElementById('overlay');

    toggleBtn.addEventListener('click', () => {
        app.classList.toggle('collapsed');
    });

    overlay.addEventListener('click', () => {
        app.classList.remove('show-sidebar');
    });
</script>
<script>
    (function () {
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', function (evt) {
                evt.preventDefault();
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (!input) return;
                const icon = this.querySelector('i');
                const isHidden = input.type === 'password';
                input.type = isHidden ? 'text' : 'password';
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
            btn.style.display = 'inline-flex';
        });

        // keep icon visible on focus/blur (avoid browser quirks)
        ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => {
            const input = document.getElementById(id);
            const btn = document.querySelector(`button[data-target="${id}"]`);
            if (!input || !btn) return;
            btn.style.visibility = 'visible';
            input.addEventListener('focus', () => btn.style.visibility = 'visible');
            input.addEventListener('blur', () => btn.style.visibility = 'visible');
        });

        // password strength + validation (same logic)
        const newPwd = document.getElementById('newPassword');
        const confirmPwd = document.getElementById('confirmPassword');
        const strengthBar = document.getElementById('pwdStrengthBar');
        const strengthText = document.getElementById('pwdStrengthText');
        const clientError = document.getElementById('clientError');
        const form = document.getElementById('changePasswordForm');
        const submitBtn = document.getElementById('submitBtn');

        const validRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[^A-Za-z0-9]).{6,}$/;

        function evaluateStrength(pwd) {
            let score = 0;
            if (!pwd) return score;
            if (pwd.length >= 6) score++;
            if (/[A-Za-z]/.test(pwd)) score++;
            if (/\d/.test(pwd)) score++;
            if (/[^A-Za-z0-9]/.test(pwd)) score++;
            return score;
        }

        function updateStrengthUI() {
            const s = evaluateStrength(newPwd.value);
            const percent = (s / 4) * 100;
            strengthBar.style.width = percent + '%';

            if (!newPwd.value) {
                strengthText.textContent = '';
                const note = document.getElementById('pwdValidNote');
                if (note) note.remove();
                return;
            }

            if (s <= 1) {
                strengthText.textContent = 'Weak password';
                strengthText.className = 'text-danger small-note';
            } else if (s === 2) {
                strengthText.textContent = 'Fair password';
                strengthText.className = 'text-warning small-note';
            } else if (s === 3) {
                strengthText.textContent = 'Good password';
                strengthText.className = 'text-info small-note';
            } else {
                strengthText.textContent = 'Strong password';
                strengthText.className = 'text-success small-note';
            }

            const validNote = document.getElementById('pwdValidNote');
            if (validRegex.test(newPwd.value)) {
                if (!validNote) {
                    const note = document.createElement('div');
                    note.id = 'pwdValidNote';
                    note.className = 'text-success small-note';
                    note.innerHTML = '<i class="fa-solid fa-check"></i> Password meets all conditions';
                    strengthText.insertAdjacentElement('afterend', note);
                }
            } else {
                if (validNote) validNote.remove();
            }
        }

        newPwd.addEventListener('input', () => {
            updateStrengthUI();
            clientError.textContent = '';
        });
        confirmPwd.addEventListener('input', () => {
            clientError.textContent = '';
        });

        form.addEventListener('submit', e => {
            clientError.textContent = '';
            const n = newPwd.value.trim(), c = confirmPwd.value.trim();
            let errors = [];
            if (!validRegex.test(n)) errors.push("Password must be at least 6 characters and include letters, numbers, and a special character.");
            if (n !== c) errors.push("New password and confirm password do not match.");
            if (errors.length) {
                e.preventDefault();
                clientError.innerHTML = errors.map(err => `<div>${err}</div>`).join('');
                newPwd.focus();
                return false;
            }
            submitBtn.disabled = true;
        });

        // init
        updateStrengthUI();
    })();
</script>
<script th:src="@{/assets/js/toast.js}"></script>
</body>
</html>
